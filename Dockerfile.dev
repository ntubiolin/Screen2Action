# Development Dockerfile for Screen2Action

FROM node:20-bullseye

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    libgtk-3-0 \
    libnotify-dev \
    libgconf-2-4 \
    libnss3 \
    libxss1 \
    libasound2 \
    libxtst6 \
    xauth \
    xvfb \
    python3 \
    python3-pip \
    python3-venv \
    tesseract-ocr \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# Install Python uv for backend
RUN pip3 install uv

# Set up virtual display for Electron
ENV DISPLAY=:99

# Copy package files first for better caching
COPY package*.json ./
COPY tsconfig*.json ./
COPY vite.config.ts ./
COPY tailwind.config.js ./
COPY postcss.config.js ./

# Install Node dependencies
RUN npm ci

# Copy backend requirements
COPY backend/pyproject.toml backend/uv.lock* ./backend/

# Set up Python environment for backend
WORKDIR /app/backend
RUN uv venv && uv sync

WORKDIR /app

# Expose ports
EXPOSE 3000 5173 8000

# Start Xvfb and run development servers
CMD Xvfb :99 -screen 0 1024x768x24 & \
    cd backend && uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload & \
    npm run dev:renderer